---
emoji: 🚇
title: subway-live 작업기 3부. 데이터 전처리
date: '2024-06-21 20:00:00'
author: 이승준
tags: 웹개발, 데이터처리
categories: 웹개발
---

## 0. 들어가며
다음으로는 데이터를 수집하고 처리하여 최종적으로 `역별 시간표`와 `열차별 시간표` 이 두 가지를 생성하는 과정을 거쳤다.

## 1. 카카오맵 API에서 역 ID 찾기
iPhone 카카오맵 앱에서 출발지점을 바꿔가며 역 ID를 찾아내었는데, 대부분 연속된 숫자라 찾기 그렇게 어렵지는 않았다. 다만 새로 개통한 *1호선 다대포해수욕장 연장구간*, *동해선 태화강 연장구간*, *동해선 부산원동역* 이 세 가지는 다소 변칙적이었다.

* 1호선
  * 신평&#126;노포: `PSS101`&#126;`PSS134`
  * 동매&#126;다대포해수욕장: `PSS1M159`&#126;`PSS1M164`
* 2호선
  * 장산&#126;양산: `PSS201`&#126;`PSS243`
* 3호선
  * 수영&#126;대저: `PSS301`&#126;`PSS317`
* 4호선
  * 미남&#126;안평: `PSS401`&#126;`PSS414`
* 부산김해경전철
  * 사상&#126;가야대: `PSS1001`&#126;`PSS1021`
* 동해선
  * 부전&#126;일광 (부산원동 제외): `PSS11M144`&#126;`PSS11M157`
  * 부산원동: `PSS11M226`
  * 좌천&#126;태화강: `PSS11M248`&#126;`PSS11M255`

이 데이터를 최종적으로 `stations.json`에 저장하였다.

## 2. 전체 역 시간표 만들기
이 파트가 전체 모든 과정 중 가장 애를 먹였는데, 처음에는 코드만 잘 짜놓으면 쉽게 넘어갈 수 있다고 생각했으나 예상치 못했던 변수가 너무 많았기 때문이다. 근본적으로는 raw data 자체에 문제가 많았기 때문이라고 볼 수 있다.

### 2-1. raw data 찾기
총 4가지의 raw data를 찾을 수 있었는데, 그 중 완벽한 데이터는 없었다. 문제점 중 골치 아프지만 해결이 불가능하지는 않은 것은 ⚠️, 해결 자체가 불가능한 것은 ❌로 표시하였다.

1. **카카오맵 내부 API**
* https://api.kakao.com/subway/station/timetable.json (실제 링크는 아님) 뒤 역 ID를 입력하여 요청을 보내면 JSON 포맷으로 가공되어 데이터가 나오기 때문에 매우 쉽게 처리가 가능하다.
* 문제점
  1. ❌ **열차번호 정보가 없다**. 이 데이터로 역별 시간표는 만들 수 있지만, 열차별 시간표는 만들 수 없다.

2. **공공데이터포털/레일포털 운행정보**
* 공공데이터포털에 부산교통공사에서 제공하는 [부산도시철도 운행 정보](https://www.data.go.kr/data/15082980/fileData.do)라는 csv 파일이 있다. 이 파일에는 열차별 & 역별 도착 및 출발시각이 모두 들어있다.
* 조사를 좀 더 해보니 레일포털에서는 [부산교통공사](https://data.kric.go.kr/rips/M_01_01/detail.do?id=11)뿐만 아니라 [김해경전철](https://data.kric.go.kr/rips/M_01_01/detail.do?id=12), [코레일](https://data.kric.go.kr/rips/M_01_01/detail.do?id=6) 등 전체 운영기관의 xlsx 파일을 제공한다.
* 문제점
  1. ❌ 부산김해경전철 파일에서 평일, 토요일, 휴일 시간표를 모두 같게 해놨다.
  2. ❌ 동해선 파일에서 역별 도착, 출발 시간이 표시되어 있지 않다.
  3. ⚠️ 역별 도착 및 출발시각이 분 단위로 있어, 초 단위 정보는 `방법 1`로 얻어야 한다.
  4. ⚠️ 대부분의 경우 hh:mm 시각이 hh:mm:ss에서 ss만 버림한 경우이지만, 4호선의 일부 열차에서는 ss를 반올림하여 시간이 맞지 않은 경우가 있다. 이 경우 오류가 나는 경우를 csv에서 일일이 찾아서 파일을 수정해야 한다.

3. **레일블루**
* 개인이 운영하는 철도 정보 관련 웹사이트이다. 이 중 [전철노선시간표](https://rail.blue/railroad/logis/timetable_schedule_sel.aspx)에 들어가 정보를 입력하면 열차별 & 역별 도착 및 출발시각이 조회 가능하다.
* 문제점
  1. ❌ 부산김해경전철의 열차번호가 후술할 레일포털에서 제공하는 표준데이터의 열차번호와 다르다.
  2. ❌ 부산김해경전철 토⋅일⋅공휴일의 가야대행 막차 직전 열차의 정보가 없다. 추측컨대 예전에 없다가 최근에 새로 생긴 듯한데, 아직 레일블루에 업데이트되지 않았다.
  3. ❌ 동해선 전철노선시간표에 재송역이 빠져 있다.
  4. ⚠️ 4호선 (전)동부산대학역이 아직 (현)윗반송역으로 업데이트되지 않았다. 이로 인해 윗반송역 시간표가 텅 비어있다.
  5. ⚠️ 동해선 일광~태화강 구간의 일부 열차에서 카카오맵 API와 다르게 표시되어 있다.
  6. ⚠️ API를 받아오는 데 시간이 오래 걸린다.

4. **레일포털 Open API**
* 국토교통부에서 제공하는 Open API 중 [열차별 운행시각표](https://data.kric.go.kr/rips/M_01_02/detail.do?id=162&service=trainUseInfo&operation=subwayTimetable)가 있다. 본인인증을 하고 활용신청을 하니 얼마 지나지 않아 메일로 `serviceKey`를 받을 수 있었다.
* 요일 코드(`dayCd`)는 토요일이 `7`, 평일이 `8`, 휴일이 `9`이다. 
* 노선 코드(`lnCd`), 운영기관 코드(`railOprIsttCd`), 역 코드(`stinCd`) 정보는 [자료실](https://data.kric.go.kr/rips/M_04_02/detail.do?id=12)에서 엑셀 파일로 제공한다.
* 문제점
  1. ⚠️ 도착시간은 제대로 표시되어 있지만, 출발시간을 도착시간과 동일하게 표시해놓았다. 이는 `방법 1`과 병용하면 해결이 가능하다.
  2. ⚠️ 1~4호선, 김해경전철 일부 열차에서 시간이 카카오맵 API와 다르게 표시되어 있다.
  3. ⚠️ API를 받아오는 데 시간이 오래 걸린다.

### 2-2. 데이터 전처리 방법 계획하기
**⭐️ 전제: raw data간 시간이 서로 달라 충돌하는 경우, 항상 `방법 1`의 시간을 취한다.**
1. 부산교통공사 관할 1~4호선
* (`방법 2`) 공공데이터포털 운행정보: ✅ 오류가 나는 일부 4호선 열차에 대해 csv에서 수정해야 하는 점(`문제점 iv`)을 제외하고 별다른 문제가 없다.
* (`방법 3`) 레일블루: ⚠️ 별다른 문제는 없으나, `방법 2`에 비해 월등히 시간이 오래 걸리기에 채택할 이유가 없다.
* (`방법 4`) 레일포털 Open API: ⚠️ 일부 열차에서 시간이 다르게 표시되어 있어 열차번호를 손수 채워넣어야 한다. `방법 2`에 비해 그 양이 많아 굳이 채택할 이유가 없다.
  > 따라서 부산교통공사에서는 `방법 2`를 사용하되, 초 단위 시간을 얻기 위해 `방법 1`과 병용하기로 했다.

2. 부산김해경전철
* (`방법 2`) 레일포털 운행정보: ❌ 토요일 및 휴일 시간표가 없다.
* (`방법 3`) 레일블루: ❌ 열차번호가 표준이 아니며, 토⋅일⋅공휴일의 가야대행 막차 직전 열차의 정보가 없다. 
* (`방법 4`) 레일포털 Open API: ✅ 김해경전철 일부 열차에서 시간이 카카오맵 API와 다르게 표시되어 있는데(`문제점 ii`), 이는 따로 예외처리를 해주면 된다.
  > 따라서 부산김해경전철에서는 `방법 4`를 사용하되, 문제점을 `방법 1`을 통해서 보완하기로 했다.

3. 동해선
* (`방법 2`) 레일포털 운행정보: ❌ 역별 도착, 출발 시간이 표시되어 있지 않다.
* (`방법 3`) 레일블루: ❌ 재송역 열차시간이 존재하지 않는다.
* (`방법 4`) 레일포털 Open API: ✅ 별다른 문제가 없다.
  > 따라서 동해선에서는 부산김해경전철과 동일한 방식(`방법 4` + `방법 1`)으로 진행하기로 하였다.

### 2-3. 데이터 전처리 하기
이제 본격적으로 데이터를 전처리해보겠다. 전처리의 각 과정에 등장하는 코드의 설명까지 일일이 달기에는 문서 양이 너무 방대해져, 코드의 주요 부분에 주석으로 설명을 단 뒤 Github 링크를 걸어두도록 하겠다.

1. [부산도시철도 운행 정보](https://www.data.go.kr/data/15082980/fileData.do)를 전처리하여 `trains_BTC.csv` 파일로 저장
2. [코드 정보](https://data.kric.go.kr/rips/M_04_02/detail.do?id=12)를 받아와서 전처리 후 `codes.csv` 파일로 저장
3. [`1-save_arrival_BTC.py`](https://github.com/leesj-dev/subway-live/blob/master/preprocessing/scripts/1-save_arrival_BTC.py) 실행 → `arrival_BTC.json`으로 저장
  * **이때 시간은 hh:mm 형태이다.**(`방법 2`의 `문제점 iii`) 나중에 개별 역 시간표 파일을 생성할 때 hh:mm:ss로 고쳐질 예정이다.

4. [`1-save_arrival_others.py`](https://github.com/leesj-dev/subway-live/blob/master/preprocessing/scripts/1-save_arrival_others.py) 실행 → `arrival_others.json`으로 저장
  * 여기 시간은 hh:mm:ss 형태로 정상적으로 표기된다.
  * 김해경전철 쪽에서 `방법 1`과 `방법 4` 간 시간이 맞지 않은 부분이 몇 개 있어 열차번호가 모두 채워지지 않는데(`방법 4`의 `문제점 ii`), 확인 결과, 아래의 열차들에서만 발생하였다. 따라서 아래의 열차들에서 10&#126;35초 차이 내 범위에서 열차를 찾도록 하는 if문 (Line 46&#126;57) 추가 후 다시 실행하였다. 
    > 사상행 1015, 1035 열차

    > 가야대행 2005, 2019, 2039 열차
5. [`2-merge_jsons.py`](https://github.com/leesj-dev/subway-live/blob/master/preprocessing/scripts/2-merge_jsons.py) 실행 → `arrival_BTC.json`, `arrival_others.json`을 합쳐 `arrival.json` 생성

환경변수는 [`env_variables.py`](https://github.com/leesj-dev/subway-live/blob/master/preprocessing/scripts/env_variables.py), 파일경로는 [`paths.py`](https://github.com/leesj-dev/subway-live/blob/master/preprocessing/scripts/paths.py), 재사용하는 함수들은 [`utils.py`](https://github.com/leesj-dev/subway-live/blob/master/preprocessing/scripts/utils.py)에 넣어 필요할 때 불러와 사용하였다.

## 3. 개별 역 시간표 파일 생성
* [`3-save_timetable.py`](https://github.com/leesj-dev/subway-live/blob/master/preprocessing/scripts/3-save_timetable.py) 실행 →
  1. `timetable` 폴더에 역별 시간표 생성
  2. `arrival.json` 중 부산교통공사(BTC)의 출발·도착시간 부분을 hh:mm에서 hh:mm:ss으로 업데이트

* 실행을 하면 부산교통공사 관할 호선 중 열차번호를 찾지 못한 부분이 나오는데(`방법 2`의 `문제점 iv`), 이들을 체크하여 `trains_BTC.csv` 수정 후 다시 실행하였다. 오류 내용은 아래에 적어두었다.
   > 2453 데이터 오류

   > 4033&#126;4045 홀수 / 평일 / 출발 & 도착 / 007번 역

   > 4003&#126;4031, 4047&#126;4309 홀수 / 평일 / 출발 / 001번 역

   > 4003&#126;4295 홀수 / 토요일 / 출발 / 001번 역

   > 4003&#126;4277 홀수 / 공휴일 / 출발 / 001번 역

## 4. 개별 열차 시간표 파일 생성
* [`4-save_traintable.py`](https://github.com/leesj-dev/subway-live/blob/master/preprocessing/scripts/4-save_traintable.py) 실행 → `traintable` 폴더에 열차별 시간표 생성

```toc
```