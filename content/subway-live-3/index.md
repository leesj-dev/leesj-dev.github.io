---
emoji: 🚇
title: subway-live 작업기 3부. 데이터 전처리
date: '2024-06-21 20:00:00'
author: 이승준
tags: 웹개발, API
categories: 웹개발
---

## 0. 들어가며
다음으로는 데이터를 수집하고 처리하여 최종적으로 `역별 시간표`와 `열차별 시간표` 이 두 가지를 생성하는 과정을 거쳤다.

## 1. 카카오맵 API에서 역 ID 찾기
iPhone 카카오맵 앱에서 출발지점을 바꿔가며 역 ID를 찾아내었는데, 대부분 연속된 숫자라 찾기 그렇게 어렵지는 않았다. 다만 새로 개통한 *1호선 다대포해수욕장 연장구간*, *동해선 태화강 연장구간*, *동해선 부산원동역* 이 세 가지는 다소 변칙적이었다.

* 1호선
  * 신평&#126;노포: `PSS101`&#126;`PSS134`
  * 동매&#126;다대포해수욕장: `PSS1M159`&#126;`PSS1M164`
* 2호선
  * 장산&#126;양산: `PSS201`&#126;`PSS243`
* 3호선
  * 수영&#126;대저: `PSS301`&#126;`PSS317`
* 4호선
  * 미남&#126;안평: `PSS401`&#126;`PSS414`
* 부산김해경전철
  * 사상&#126;가야대: `PSS1001`&#126;`PSS1021`
* 동해선
  * 부전&#126;일광 (부산원동 제외): `PSS11M144`&#126;`PSS11M157`
  * 부산원동: `PSS11M226`
  * 좌천&#126;태화강: `PSS11M248`&#126;`PSS11M255`

이 데이터를 최종적으로 `stations.json`에 저장하였다.

## 2. 전체 역 시간표 만들기
이 파트가 전체 모든 과정 중 가장 애를 먹였는데, 처음에는 코드만 잘 짜놓으면 쉽게 넘어갈 수 있다고 생각했으나 예상치 못했던 변수가 너무 많았기 때문이다. 근본적으로는 raw data 자체에 문제가 많았기 때문이라고 볼 수 있다.

### 2-1. raw data 찾기
1. **카카오맵 내부 API**
* https://api.kakao.com/subway/station/timetable.json (실제 링크는 아님) 뒤 역 ID를 입력하여 요청을 보내면 JSON 포맷으로 가공되어 데이터가 나오기 때문에 매우 쉽게 처리가 가능하다.
* 문제점
  * **열차번호 정보가 없다**. 이 데이터로 역별 시간표는 만들 수 있지만, 열차별 시간표는 만들 수 없다.

2. **공공데이터포털**, **레일포털** 운행정보
* 공공데이터포털에 부산교통공사에서 제공하는 [부산도시철도 운행 정보](https://www.data.go.kr/data/15082980/fileData.do)라는 csv 파일이 있다. 이 파일에는 열차별 & 역별 도착 및 출발시각이 모두 들어있다.
* 조사를 좀 더 해보니 레일포털에서는 [부산교통공사](https://data.kric.go.kr/rips/M_01_01/detail.do?id=11)뿐만 아니라 [김해경전철](https://data.kric.go.kr/rips/M_01_01/detail.do?id=12), [코레일](https://data.kric.go.kr/rips/M_01_01/detail.do?id=6) 등 전체 운영기관의 xlsx 파일을 제공한다.
* 문제점
  * 역별 도착 및 출발시각이 분 단위로 있어, 초 단위 정보는 `방법 1`로 얻어야 한다.
  * 대부분의 경우 hh:mm 시각이 hh:mm:ss에서 ss만 버림한 경우이지만, 4호선의 일부 열차에서는 ss를 반올림하여 시간이 맞지 않은 경우가 있다. 이 경우 오류가 나는 경우를 일일이 찾아서 파일을 수정해야 한다.

3. **레일블루**
* 개인이 운영하는 철도 정보 관련 웹사이트이다. 이 중 [전철노선시간표](https://rail.blue/railroad/logis/timetable_schedule_sel.aspx)에 들어가 정보를 입력하면 열차별 & 역별 도착 및 출발시각이 조회 가능하다.
* 문제점
  * 4호선 (전)동부산대학역이 아직 (현)윗반송역으로 업데이트되지 않았다. 이로 인해 윗반송역 시간표기 텅 비어있다.
  * 부산김해경전철의 열차번호가 후술할 레일포털에서 제공하는 표준데이터의 열차번호와 다르다.
  * 부산김해경전철 토⋅일⋅공휴일의 가야대행 막차 직전 열차의 정보가 없다. 추측컨대 예전에 없다가 최근에 새로 생긴 듯한데, 아직 레일블루에 업데이트되지 않았다.

4. **레일포털** Open API
    * 국토교통부에서 제공하는 Open API 중 [열차별 운행시각표](https://data.kric.go.kr/rips/M_01_02/detail.do?id=162&service=trainUseInfo&operation=subwayTimetable)가 있다. 본인인증을 하고 활용신청을 하니 얼마 지나지 않아 메일로 `serviceKey`를 받을 수 있었다.
    * 요일 코드(`dayCd`)는 토요일이 `7`, 평일이 `8`, 휴일이 `9`이다. 
    * 노선 코드(`lnCd`), 운영기관 코드(`railOprIsttCd`), 역 코드(`stinCd`) 정보는 [자료실](https://data.kric.go.kr/rips/M_04_02/detail.do?id=12)에서 엑셀 파일로 제공한다.

### 2-2. 시행착오
처음에는 `방법 1`, `방법 2` 중 공공데이터포털, `방법 3`만 인지하고 있었다. 이를 이용하여 다음의 과정으로 접근하였다:
* 부산교통공사 관할 1&#126;4호선
  1. `방법 2`에서 csv 파일을 다운로드하고 전처리하여 dictionary 형태로 저장한다.
  2. `방법 1`에서의 JSON 파일의 시간을 dictionary와 대조하여 hh:mm 부분이 같다면 열차번호를 추가한다. 
* 부산김해경전철, 동해선
  1. `방법 3`에서 시간표를 크롤링하여 dictionary 형태로 저장한다.

하지만 근본적으로 `방법 3`이 가지는 한계인 **열차번호 정보의 비표준성**으로 인해, 다른 방법들을 찾아보다가 `방법 4`를 발견하였다.

(To be continued...)

## 3. 개별 역 시간표 파일 생성

## 4. 개별 열차 시간표 파일 생성


```toc
```